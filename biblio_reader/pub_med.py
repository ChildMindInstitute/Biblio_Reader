import pandas as pd
import unidecode
import urllib.request as urllib
import xml.etree.ElementTree as etree

with open('inputs/FCP_DATA.csv', 'r') as f:
    data = pd.read_csv(f)


def safeint(x):
    try:
        return int(x)
    except:
        return x


def filterstr(str, filter, decode=True):
    for char in str:
        if char in filter:
            str = str.replace(char, '')
    if decode:
        return unidecode.unidecode(str)
    else:
        return str


def joindata(row):
    row.fillna('')
    return '&'.join(['https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi?db=pubmed', 'term='
                     + filterstr(str(row['Title']).strip().lower(), ")'>',\```[](<}{"), 'retmax=1', 'field=title',
                     'year=' + str(safeint(row['Year'])), 'author=' +
                     filterstr(str(row['Authors']).lower().split(' & ')[0],
                               ")'',```'[\](}{')")]).replace(' ', '+').replace('"', '')


def getid(url):
    res = []
    try:
        xml = urllib.urlopen(url).read()
    except:
        return res
    for idlist in etree.fromstring(xml).findall('IdList'):
        for id in idlist:
            res.append(id.text)
    return res

def getids():
    ids = []
    for row in data.iterrows():
        ids.append(getid(joindata(row[1])))
    data['PMCIDS'] = ids


data['PMCIDS'] = [['21653723'], ['20176931'], ['20577591'], ['23861951'], ['27503879'], ['23774715'], ['23499792'], ['25406711'], ['22233733'], ['21769991'], ['26168121'], ['22366334'], ['26025199'], ['27895547'], ['22169776'], ['21347218'], ['23702418'], ['21459148'], ['22433046'], ['26493108'], ['23085497'], ['22116037'], ['23571418'], ['24875392'], ['24577245'], ['23803651'], ['23047070'], ['27852375'], ['22832566'], ['25599222'], ['24210821'], ['23333262'], ['22248579'], ['21068309'], ['23966925'], ['24565362'], ['23382713'], ['23390554'], ['24899709'], ['23440216'], ['22171056'], ['25109530'], ['23458776'], ['24811386'], ['20589099'], ['22440648'], ['23747457'], ['23631983'], ['23631991'], ['22440651'], ['26621705'], ['24333927'], ['23087608'], ['21282318'], ['23747458'], ['20688177'], ['24956047'], [], ['23921101'], ['23319644'], ['22341211'], ['23967180'], [], ['22493576'], ['23425893'], ['25433958'], ['21653865'], ['27012503'], ['23541632'], ['24415902'], ['25316335'], ['21931335'], ['23123682'], ['22037497'], ['25977800'], ['25331597'], ['25349916'], ['24496901'], ['23776244'], ['25770990'], ['25891007'], ['23173916'], [], ['23583357'], ['26254595'], ['23847528'], ['25233316'], ['21251646'], ['24791032'], ['24862074'], ['24879923'], ['25381736'], ['22973200'], ['26427642'], ['24903825'], ['24176176'], ['24223118'], ['22212597'], ['25713839'], ['24496902'], ['21094686'], ['23792981'], ['25012461'], ['23227001'], ['21856431'], ['20884276'], ['26175908'], ['25372846'], ['24421764'], [], ['21878483'], ['24183779'], ['23755001'], ['26347640'], ['22424873'], ['25844325'], ['26595653'], ['22784277'], ['24904400'], [], ['21425398'], ['22958829'], ['24343892'], ['22412922'], ['25795704'], ['21572088'], ['23422254'], ['28338943'], ['21964480'], ['23631994'], ['23563062'], ['22284177'], ['22227886'], ['25349910'], ['24449864'], [], ['24093016'], [], ['24668728'], ['24177990'], ['26336909'], [], ['26170004'], ['26687667'], ['24583255'], ['24123508'], ['25987366'], ['24198778'], ['23825652'], ['26061743'], ['24702246'], ['21643732'], [], ['23926116'], ['22952978'], ['25180572'], ['23087605'], ['22622767'], ['25116862'], ['27138646'], ['24657780'], ['24585433'], ['24287438'], ['22910401'], ['23136657'], ['25462801'], ['25987368'], ['22645253'], ['23964221'], ['23927904'], ['24113873'], ['23705677'], ['23899725'], ['22305955'], [], ['27075850'], ['22969709'], ['22996803'], ['21420500'], ['25937563'], ['25862264'], ['28297823'], [], ['25850620'], ['22493575'], ['25309643'], ['24238779'], ['24146606'], ['25840117'], ['26058882'], ['21761686'], ['23851068'], ['25583500'], ['21636787'], ['24904347'], ['23129267'], ['27073219'], ['24738703'], ['27346545'], ['22507229'], ['25048627'], ['26469048'], ['23227153'], [], ['24062654'], ['24361664'], ['22969710'], ['22659444'], ['22076305'], ['25011468'], ['22498657'], ['25569764'], ['25243989'], ['25181023'], ['23408984'], ['22291667'], ['22912605'], ['24078018'], ['24466256'], ['24728207'], ['25482016'], ['25797238'], ['23242198'], ['25837600'], ['26924939'], ['22882112'], ['27209150'], ['23696841'], ['23727024'], ['23684384'], ['23049834'], ['25257972'], ['25727858'], ['23226127'], [], ['23791961'], ['24560717'], ['22432450'], ['25765326'], [], ['25148416'], ['25212469'], ['24860698'], ['23571422'], ['24705817'], ['21554336'], ['22888314'], ['22952990'], ['22846658'], ['23060754'], ['24260229'], ['24951837'], ['24550788'], ['23160115'], ['23669074'], [], ['24922325'], ['24860458'], ['21858129'], ['24878823'], ['23959625'], ['26834533'], ['22465841'], ['21516259'], ['22629375'], ['25701614'], ['27153982'], ['26699491'], ['26788282'], ['26123376'], ['23390412'], ['23151955'], ['25374531'], [], ['25685703'], ['22408270'], ['24179822'], ['25252664'], [], ['26146755'], ['26109666'], ['23133413'], ['25547636'], [], ['26106547'], ['24869925'], ['20808870'], ['23872155'], ['23715061'], ['23597177'], ['26686668'], ['24029388'], ['24672471'], ['26163799'], [], ['24788815'], ['26515902'], ['25435598'], ['25941089'], ['24200207'], ['22735157'], ['23510272'], ['26036957'], ['22387608'], [], ['26493162'], ['25464373'], ['22174905'], ['25241907'], ['24308753'], ['24349569'], ['23240997'], ['22766721'], ['23162439'], ['21727938'], ['25505309'], ['23593367'], ['24103922'], ['26146534'], ['21406628'], ['27075704'], ['26493275'], ['25776219'], ['24391605'], ['26941174'], ['25602243'], ['28340130'], ['23267318'], ['23641233'], ['24502324'], ['26543004'], [], ['26223259'], ['27389358'], ['22988433'], ['23836389'], ['23348760'], ['23847511'], ['23781190'], ['24657999'], ['24860442'], ['23611263'], ['24745956'], ['25100988'], ['26714192'], ['22931854'], ['25949925'], ['24302911'], [], ['24438507'], ['22659480'], ['27693256'], ['24390538'], ['27471443'], ['23417795'], ['24704268'], ['23015782'], ['24560325'], ['23205551'], ['26040537'], ['26204262'], ['26045942'], ['26347127'], ['25810900'], ['26030703'], ['25959391'], ['25311282'], ['25641208'], ['22066005'], ['25309910'], ['24615988'], ['24844743'], ['25150630'], ['24579191'], [], ['23982973'], ['24324431'], ['23643924'], ['23033990'], ['27161151'], ['26241681'], ['26843002'], ['25116896'], ['24161400'], ['25428212'], ['26713076'], ['28053326'], [], ['27076193'], ['27114898'], ['23852814'], ['25576588'], ['27421791'], ['28044025'], ['25713528'], ['26364860'], ['26173024'], ['25977805'], ['23024630'], ['26732133'], ['24032010'], ['23867559'], ['22930323'], [], ['25234074'], ['26599279'], [], [], ['24982615'], ['25445623'], ['25386919'], ['25827811'], ['25745384'], [], ['25809403'], ['22342804'], ['27330652'], ['26493163'], ['23012584'], ['25514518'], ['25656317'], ['24069220'], ['24200210'], ['23707580'], ['26148789'], ['26707088'], ['26044860'], ['26413910'], ['26973170'], ['27751941'], ['24736176'], ['27236083'], ['26097453'], ['26617216'], ['25982222'], ['26759786'], [], ['26821847'], ['24238089'], ['23440209'], ['23458627'], ['26226088'], ['25733379'], ['26123379'], ['25492905'], ['26236224'], ['26365788'], ['25307115'], [], ['25613588'], ['26669858'], ['24936432'], ['25927014'], ['25188284'], [], ['23402339'], ['23894288'], ['23488575'], ['22590522'], ['26975670'], ['28170383'], ['26106557'], [], [], ['26642966'], ['26023326'], ['24350655'], [], ['27864082'], ['26223261'], ['26019122'], ['27713929'], ['25750922'], ['26946501'], ['24297675'], ['22515798'], ['24042040'], [], ['27479844'], ['26733386'], ['27059857'], ['27634551'], ['26106564'], ['23284629'], ['24343754'], ['23912507'], ['24699668'], ['25346721'], ['24954282'], ['25460595'], [], ['24001350'], ['22584775'], ['26586812'], ['25630517'], [], ['26267019'], ['26145769'], ['25899706'], ['25841798'], ['26805582'], ['26236216'], ['26059228'], ['19633959'], ['23314416'], ['24742919'], ['26855233'], ['26149095'], ['27412228'], ['19684263'], ['26834084'], [], ['27012314'], ['26701695'], ['27667698'], ['26880689'], ['26476740'], ['26750447'], ['21378114'], ['25888923'], ['27125303'], ['27060621'], ['27241201'], ['21530613'], [], ['26859312'], [], ['22765879'], ['25613438'], ['26106561'], ['26723151'], ['26214066'], [], ['22866039'], ['26578859'], ['26106551'], [], ['26043845'], ['25826237'], ['21840243'], ['25328859'], ['24926252'], ['24338247'], ['26958466'], ['24748378'], [], ['24058331'], ['23879766'], [], ['23329729'], ['22400627'], ['22086306'], ['23133518'], ['21477286'], [], [], ['25977807'], ['26388757'], ['26364863'], [], ['26528395'], [], ['25927525'], ['26455546'], ['25762911'], ['27746319'], ['26656726'], ['26525656'], ['27282475'], [], ['26234499'], [], ['25710031'], ['25741265'], ['25320797'], ['26404019'], ['26446859'], ['27069771'], ['23675425'], [], ['27430030'], ['25793106'], [], [], ['27014049'], ['25655872'], ['26469182'], ['27664827'], ['28340003'], ['27522070'], ['25761828'], [], [], ['26311606'], ['24398054'], ['24795856'], ['20955930'], ['27073219'], ['25149267'], ['27423255'], ['22174743'], ['23927901'], ['28209228'], ['24023609'], ['24103376'], ['24395657'], ['24914522'], ['24760946'], ['25333359'], ['25414626'], ['24246490'], ['25122466'], ['24211982'], ['24557703'], ['25951196'], ['26435832'], ['26484047'], ['25720017'], ['25630444'], ['25957598'], ['26475494'], ['25585020'], [], ['26376381'], ['27739385'], ['25982516'], ['27194227'], ['27044997'], ['27115120'], ['27211526'], [], ['26802781'], ['27242395'], ['26873041'], [], ['27165761'], ['27414048'], ['27199653'], ['27510328'], [], ['27147940'], ['27783066'], ['26834533'], ['27458367'], ['24424576'], ['26352632'], ['26989195'], [], ['26156558'], [], ['27372336'], [], ['27868367'], [], ['26821773'], ['22056459'], ['26327244'], ['26596551'], ['26559474'], [], ['24586801'], [], ['23747287'], ['23802999'], ['24139654'], ['23727315'], ['26234701'], ['26503036'], ['26317222'], ['26092432'], [], [], ['25598522'], ['25821110'], ['26441493'], ['25567423'], ['26212146'], ['25652348'], ['26180782'], ['27534828'], ['26778951'], ['26178250'], ['26613549'], ['26405427'], ['26272728'], ['26106821'], ['26107049'], [], ['25795197'], ['26352147'], ['22354559'], [], ['26737238'], [], ['27747500'], [], ['24766561'], ['24747737'], ['26037887'], ['24624052'], ['25165444'], ['25566037'], ['24342841'], ['23775173'], ['24128143'], ['28340447'], [], ['23248579'], [], [], ['22395690'], ['23060755'], ['21296165'], [], ['27157788'], [], [], ['26483621'], ['27669991'], ['26208373'], [], ['28291247'], ['27676697'], ['27836708'], ['26210336'], ['26528123'], ['26257695'], [], ['27132874'], [], [], ['24575752'], ['26693400'], [], ['23286130'], ['27027541'], ['24687195'], ['26997116'], [], ['25524841'], ['25700675'], ['26416398'], [], ['26282855'], ['26640765'], [], ['27018167'], ['28275335'], ['25260934'], ['27601975'], [], ['26505141'], ['26941658'], [], ['27282107'], ['26869916'], ['26924633'], ['27112129'], ['27843153'], ['28340447'], ['27870420'], ['28092321'], ['27088054'], ['27594820'], ['26346144'], [], ['26666502'], ['27269967'], ['27784176'], [], [], ['26896814'], ['26245836'], ['21365601'], ['21331699'], ['22245346'], ['22405733'], ['22941499'], ['25386128'], ['24096724'], ['23986695'], [], [], ['25224735'], ['24966831'], ['24771253'], [], [], [], ['25653582'], ['25120443'], ['24947161'], [], ['25260207'], [], ['26131023'], [], [], ['26343862'], [], ['26057592'], [], [], [], ['26277116'], [], [], ['26353378'], [], ['25979045'], ['26527172'], [], ['26340046'], ['26334022'], [], [], [], ['26005099'], ['26231206'], [], [], ['25918034'], ['27747565'], [], ['26600385'], [], ['23571657'], ['24297904'], ['28220377'], [], [], [], [], [], ['23400257'], ['27865923'], ['27148015'], [], ['25400576'], ['27168362'], ['27814962'], ['27547729'], [], [], [], ['27166430'], [], ['27147940'], ['22594994'], ['27990125'], ['26454817'], ['27065101'], [], ['26494522'], ['27000303'], [], [], ['27782853'], ['27411386'], ['25185759'], ['27774713'], ['20740397'], ['26825442'], ['27358766'], ['24513233'], ['27896947'], [], ['27048963'], ['27994534'], ['27859973'], ['26888057'], ['28184409'], ['27344938'], ['27429731'], ['27042293'], ['26662457'], ['28035569'], ['27030024'], ['27983754'], [], ['28010939'], [], [], [], ['27869148'], ['27408791'], ['27270602'], ['27303280'], ['25327308'], ['27284688'], ['27868393'], ['26791806'], [], ['27500640'], [], [], ['27226895'], ['27859903'], [], ['26646924'], ['27708574'], ['27919750'], [], ['26994344'], ['27757062'], ['27856121'], ['26985666'], ['20376014'], [], [], ['26749003'], ['26094850'], ['27514582'], ['26689815'], ['27608760'], ['27313505'], [], ['27281745'], ['27532879'], [], [], ['26773910'], ['24817850'], ['27394716'], ['27890805'], [], ['27613921'], ['25419257'], ['26483660'], [], ['27600846'], [], ['27375419'], ['23897144'], [], [], ['25964743'], [], [], ['26346238'], ['26579066'], ['28164728'], ['26509111'], ['26451751'], [], ['28157660'], ['26572730'], ['27279746'], [], ['26537477'], [], [], [], [], ['26545233'], ['25685794'], ['26029082'], [], [], ['28337552'], [], [], [], [], [], [], [], [], [], [], [], [], ['28340480'], [], [], [], [], ['24117388'], [], [], ['18212797'], [], ['23786459'], ['25892971'], ['25844159'], [], [], [], ['25485445'], ['24840174'], [], [], [], [], [], [], [], [], [], [], ['26733822'], [], [], ['20376012'], [], ['22424873'], ['25352826'], ['23700282'], ['24297676'], [], ['23625719'], [], [], [], [], [], [], [], [], [], [], [], ['23634306'], [], [], ['26210326'], ['28057930'], [], [], [], ['23382713'], [], [], ['28195583'], [], ['28219775'], ['27695408'], ['19278441'], [], ['27995071'], [], [], [], [], ['28223929'], [], [], ['26565394'], [], [], [], ['24951837'], ['28269602'], ['28105655'], ['21795627'], ['27989779'], [], [], [], [], ['27604154'], ['20176931'], [], [], ['25188284'], [], ['27875803'], ['27746713'], ['25090040'], [], ['28068486'], [], [], [], [], [], [], ['26963295'], [], [], ['28101064'], ['27242476'], ['27702810'], [], [], [], ['28128250'], ['27807912'], [], [], [], [], [], [], ['28187889'], [], [], [], [], [], [], ['28230847'], ['28291247'], ['28174516'], ['28097074'], [], [], ['28268524'], ['27630538'], [], [], [], [], ['28269073'], [], [], [], [], ['27939828'], [], [], [], [], [], ['27402343'], ['28149963'], ['27967144'], ['28213119'], [], ['27179315'], [], [], ['27871642'], ['27346081'], [], [], ['28043908'], [], [], [], [], [], [], [], [], [], [], [], [], [], [], ['27833547'], ['23284629'], [], ['28188914'], [], [], [], [], [], [], [], ['27357671'], [], [], [], [], ['26505393'], [], [], ['28295837'], [], ['27507129'], ['25320794'], [], [], [], ['27881961'], [], [], ['27832449'], ['28087243'], [], [], ['27153982'], [], [], [], [], [], [], [], [], [], [], [], [], [], ['27494180'], ['3070569'], [], [], [], [], [], [], ['27995071'], [], ['28340348'], [], ['25822851'], [], [], [], [], [], ['28336088'], ['28340447'], [], [], [], [], [], [], ['28256774'], [], [], ['27865786'], [], ['27697060'], [], ['26352412'], ['28335460'], [], [], [], ['26673113'], [], [], [], ['27791126'], [], [], [], ['28094820'], [], ['28263011'], [], ['27977875'], ['27587858'], ['28091559'], [], [], [], [], [], [], [], ['26858592'], ['28072842'], ['26995240'], ['28238605'], [], ['28017880'], [], ['27020961'], ['28260392'], [], [], [], ['24936432'], ['27989844'], ['26958307'], ['25955920'], [], [], [], [], [], [], [], ['28275348'], ['27965598'], [], ['6789051'], [], ['27865786'], ['28077184'], [], [], [], [], [], [], ['28233921'], ['28065836'], [], ['28143774'], ['28258508'], ['27785124'], ['28130192'], ['27752054'], ['28202133'], [], [], [], [], [], [], [], [], ['28000020'], ['28104412'], [], ['26427642'], ['26494797'], [], [], ['26751141'], [], ['27452960'], [], [], ['28223033'], [], ['28112456'], [], [], ['27601973'], ['27050322'], ['28289370'], ['27713815'], [], [], [], ['28169310'], [], ['27397632'], ['28034766'], ['28196374'], [], [], [], [], [], [], ['25721267'], [], [], [], ['27484308'], [], [], [], ['28161310'], ['27825394'], ['28327935'], [], [], ['27489770'], [], [], ['28230841'], [], [], [], [], [], [], [], [], [], [], [], [], ['27915121'], [], [], [], [], [], ['26148908'], [], [], [], [], [], [], [], ['28334131'], [], [], [], [], ['27042293'], [], ['26889901'], [], [], [], ['27057155'], [], [], [], [], ['26510634'], [], [], [], ['27768717'], [], ['26642966'], [], ['26860835'], [], [], [], [], [], [], ['28031999'], ['28032396'], ['26969310'], [], [], [], [], [], [], [], [], ['26888614'], ['27457676'], [], [], ['27941946'], [], [], ['27613854'], [], [], [], ['27969061'], [], [], ['27378915'], ['26097453'], [], [], [], ['28186338'], [], [], [], [], [], ['27995071'], [], ['28182017'], [], [], [], ['28040544'], [], [], [], ['27585835'], ['26072569'], ['27830769'], [], [], ['28191550'], [], [], ['28261074'], [], ['27995071'], [], [], [], [], [], ['28261052'], ['27535871'], ['28197860'], ['27211526'], ['26854849'], [], [], ['26445284'], [], [], ['28210428'], ['27891212'], [], ['26880161'], ['28074352'], ['28261045'], ['28232122'], ['28084105'], ['11184667'], [], ['28043908'], [], [], [], [], [], [], ['27891068'], [], ['26871897'], [], ['28340447'], ['26878067'], [], ['23781190'], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], ['27394788'], ['20176931'], [], [], [], [], [], [], ['23962475'], ['26812442'], [], [], [], ['17687871'], [], ['28340406'], ['28340385']]

def changeids(id):
    if len(id) == 1:
        res = id[0]
        return res
data['PMCIDS'] = data['PMCIDS'].apply(lambda x: changeids(x))
with open('outputs/FCP_DATA_wIDS', 'w') as f:
    f.write(data.to_csv())




