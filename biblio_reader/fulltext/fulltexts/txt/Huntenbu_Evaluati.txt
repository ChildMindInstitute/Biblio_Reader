1st examiner Dr. Daniel S. Margulies
Neuroanatomy and Connectivity
Max Planck Institute for Human Cognitive
and Brain Sciences, Leipzig

2nd examiner Prof. Dr. Felix Blankenburg
Neurocomputation and Neuroimaging
Department for Psychology
Free University of Berlin

Evaluating nonlinear coregistration
of BOLD EPI and T1w images
Master Thesis
In partial fulfillment of the Master of Science
Social, Cognitive, Affective Neuroscience

Julia Huntenburg, ID 4686947
Leuthener Str. 5, 10829 Berlin
ju.huntenburg@gmail.com

Evaluating nonlinear coregistration of BOLD EPI and T1 images

Abstract
In view of geometric distortions in EPI images, correction methods are required to enable
accurate mapping to the brain anatomy. Nonlinear coregistration constitutes an interesting
alternative in the absence of gold-standard correction approaches such as fieldmapping and
reverse phase encoding. Although early investigations of nonlinear coregistration have
yielded encouraging results, the method has not been widely adopted for neuroimaging
analysis due to the lack of extensive evaluation and user-friendly implementation. Here, the
usefulness of direct, nonlinear BOLD EPI and T1w image coregistration for standard
applications is explored. A practicable framework is provided through the integration of
required preprocessing steps and nonlinear transformation with Advanced Normalization
Tools (ANTs) in a single Nipype workflow. Different versions of the pipeline were tested on
a large set of real imaging data as well as on simulated data. In a direct comparison to
existing methods no satisfactory results could be obtained for nonlinear coregistration. In
particular, a lack of robustness across datasets challenges the viability of nonlinear
coregistration for distortion correction on a larger scale and highlights the importance of
extensive evaluation procedures.
Keywords: nonlinear coregistration, distortion correction

1

Evaluating nonlinear coregistration of BOLD EPI and T1 images

Introduction
In functional magnetic resonance imaging (fMRI), coregistration of functional time series to
a high resolution anatomical image is crucial for accurate localization (Toga & Thompson
2001; Brett et al. 2002). Classical implementations of intrasubject, intermodal registration
rely on linear transformation algorithms, assuming that geometric proportions remain
constant across imaging modalities. Unlike structural images, functional scans often suffer
from distortions, rendering the supposition of geometric consistency partially invalid (Jezzard
& Clare 1999). To overcome the effect of distortion bias in functional images, linear
transformations need to be supplemented with appropriate methods for distortion correction
(Hutton et al. 2002; Jezzard 2012). While existing correction techniques based on fieldmaps
(Jezzard & Balaban 1995; Weisskoff & Davis 1992) and reverse phase encoding (Andersson
et al. 2003) achieve good results, they naturally entail certain limitations. Nonlinear
transformation algorithms have been suggested as an alternative approach for distortion
correction (Kybic et al. 2000; Studholme et al. 2000; Gholipour et al. 2008a). Yet, large-scale
evaluation and application-friendly implementation of this method remain outstanding issues.

Geometric distortions in EPI images
The majority of current fMRI studies rely on blood oxygen level dependent (BOLD) (Ogawa
et al. 1990) echo planar imaging (EPI) sequences (Mansfield 1977). These provide the
temporal resolution required to track functional dynamics at the cost of high susceptibility to
magnetic field inhomogeneities. Inevitably, the presence of a subject in the scanner
introduces inhomogeneities in the static magnetic field (B0) as well as the superimposed
gradient fields, which cannot be completely overcome by shimming (Cusack et al. 2003). It is
thus a well recognized problem that EPI images suffer from geometric distortions due to
nonlinearity of spatial encoding gradients (Jezzard 2012). Driven by high susceptibility
differences, distortions particularly affect brain regions near bones or air filled sinuses such
as orbitofrontal cortex (OFC) and the temporal lobes. Because phase errors accumulate over
time, distortions are substantially scaled up in the direction of phase encoding where the time
between acquisition of adjacent voxels is greatest. Here, shifts can be augmented to the order
of several voxels (Jezzard & Balaban 1995). The erroneous signal displacement severely

2

Evaluating nonlinear coregistration of BOLD EPI and T1 images

compromises coregistration to structural images and can eventually impair functional analysis
in respective areas (Villain et al. 2010).

Fieldmaps and reverse phase encoding
A popular approach to counteract distortion artefacts employs explicit, individual maps of B0
inhomogeneities (Jezzard & Balaban 1995; Weisskoff & Davis 1992; Chen & Wyrwicz 1999;
Reber et al. 1998). Those so called fieldmaps are derived based on the phase shift between
two non-EPI scans with a slight echo time offset and then used to unwarp the distorted EPI
image along the phase encoding direction. More recently it has been suggested that an EPI
scan with a reverse phase encoding gradient and opposite distortions from the time series can
be used to derive an off-resonance field for a similar correction (Andersson et al. 2003;
Holland et al. 2010). However, some constraints of the aforementioned approaches persist.
Both methods require additional scanning time and prospective planning, the latter precluding
application to existing data. The fidelity of correction will vary with the quality of the
additional scans as faithful reconstruction of fieldmaps from phase information depends on
the noise level of the images (Hutton et al. 2002). Moreover, accuracy of the correction
cannot necessarily be assumed in the presence of strong inhomogeneities as shown for
fieldmaps by Wu and colleagues (Wu et al. 2008).

Nonlinear coregistration
Alternatively, the deformation required for distortion correction can be derived directly
through nonlinear coregistration of EPI and T1w images 1 (Kybic et al. 2000; Studholme et al.
2000; Gholipour et al. 2008a). Nonlinear algorithms are widely used for intersubject,
intramodal registration problems but their adaption for EPI and T1w coregistration poses
serious challenges. Different image contrasts between modalities require additional
preprocessing and restrict the choice of similarity metrics (Bhushan et al. 2012). Moreover,
limited structural information in EPI images makes it extremely difficult to establish faithful
correspondence to the anatomy. It is therefore crucial to prevent unreasonable displacement

1

While the focus here are distortions in BOLD EPI images, similar issues pertain to the use of EPI sequences in
diffusion weighted imaging (DWI). Interestingly, the idea of nonlinear coregistration has been explored more
extensively in DWI (Wu et al. 2008; Tao et al. 2009; Bhushan et al. 2012; Daga et al. 2013) . It remains unclear
how the outcomes translate between imaging modalities.

3

Evaluating nonlinear coregistration of BOLD EPI and T1 images

by imposing constraints on the deformation field (Gholipour et al. 2007). Previous studies for
instance informed their transformation model with physics-based constraints concerning the
smoothness of the deformation field (Studholme et al. 2000) and restricted deformations
largely to phase encoding direction (Gholipour et al. 2008a). While the results of those
procedures are generally encouraging, they have not made it to common practice fMRI
analysis. Potential reasons include the lack of large-scale evaluation and availability in
common neuroimaging software. Moreover, additional scans are often required, involving
similar problems as field based methods.
The present study addresses some of the issues potentially arresting the adoption of nonlinear
coregistration beyond a specialized community. It explores the possibility of direct nonlinear
coregistration between EPI and T1w images within a user-friendly pipeline, exclusively
employing common neuroimaging software. Performance and robustness of the correction
are evaluated based on a large real dataset as well as simulated data in comparison to
established correction techniques.

Methods
Data acquisition
Neuroimaging data of 73 healthy participants (31.6 ± 16.3 years old, 36 female) from the
Leipzig Cohort for Mind-Body-Emotion Interactions (LEMON) was included in the study.
The subjects gave informed consent and all protocols were approved by the local ethics
committee at the University of Leipzig, Faculty of Medicine. Data was acquired on a 3 Tesla
Siemens Verio Scanner using a 32 channel head coil. For each subject, a T1w anatomical
image was acquired using a magnetization prepared two rapid acquisition gradient echo
sequence (MP2RAGE, TR = 5 s, TE = 2.92 ms, TI 1 = 700 ms, TI2 = 2500 ms, flip angle1 =
4° , flip angle2 = 5°, voxel size = 1 × 1 × 1 mm, FOV = 256 mm, 176 slices). Further, a
BOLD weighted resting state time series containing 657 contiguous volumes was collected
with a gradient echo EPI sequence (TR = 1.4 s, TE = 30 ms, flip angle = 69°, multiband
factor = 4, voxel size = 2.3 × 2.3 × 2.3 mm, FOV = 202 mm, 64 slices, phase encoding =
anterior-posterior (AP)). A pair of gradient echo non-EPI scans (TR = 0.68 s, TE 1 = 5.19 ms,
TE2 = 7.65 ms, flip angle = 60°, voxel size = 2.3 × 2.3 × 2.3 mm, FOV = 202 mm, 64 slices)
and two sets of spin echo EPI scans (TR = 2.2 s, TE = 50 ms, flip angle = 90°, multiband

4

Evaluating nonlinear coregistration of BOLD EPI and T1 images

factor = 4, voxel size = 2.3 × 2.3 × 2.3 mm, FOV = 202 mm, 64 slices, phase encoding = AP,
3 volumes / PA, 3 volumes) were acquired for fieldmap and reverse phase encoding
correction, respectively.

Image processing
To ensure reproducibility and enable smooth interfacing of different neuroimaging software,
all data processing was streamlined using Nipype2 (Gorgolewski et al. 2011). An overview of
the processing pipeline is shown in Figure 1a. Brain extraction of T1w images was performed
with MIPAV3 (McAuliffe et al. 2001) in JIST environment 4 (Lucas et al. 2010) employing
CBS Tools MP2RAGE Background Masking (Bazin et al. 2014) and the SPECTRE 2010
algorithm (Carass et al. 2011). Subsequently, cortical reconstruction and volumetric
segmentation was performed with Freesurfer (Dale et al. 1999; Fischl et al. 1999).
Transformation into standard space (MNI152, voxel size = 1 × 1 × 1 mm) was derived using
ANTs5 (Avants et al. 2011). Functional images were realigned to the first volume using FSL
MCFLIRT (Jenkinson et al. 2002). A temporal average of the motion corrected time series
was used for rigid coregistration to the subject's T1w image, carried out with a combination
of FSL FLIRT (Jenkinson & Smith 2001) and Freesurfer bbregister (Greve & Fischl 2009).
Distortion correction was either omitted (uncorrected) or carried out employing one out of

2

http://nipy.sourceforge.net/nipype/
http://mipav.cit.nih.gov/index.php
4
http://www.nitrc.org/projects/jist/
5
http://stnava.github.io/ANTs/
3

5

Evaluating nonlinear coregistration of BOLD EPI and T1 images

three

different

methods

described

below

(fieldmap,

topup,

nonlinear).

Finally,

transformations from distortion correction and coregistration were collapsed and applied to
the temporal mean image in a single interpolation. Where necessary, the mean image was
further projected into standard space using the transformation derived from the anatomical
data before.
B0 field based distortion correction (fieldmap). Correction based on explicit mapping of B0
field inhomogeneities was carried out using the fsl_prepare_fieldmap script and FUGUE
(Jenkinson et al. 2012). The phase image was scaled to radians per second, phase unwrapped
and tightly masked. The resulting fieldmap was converted into a map of shift values in voxel
space (shiftmap) and unmasked to avoid edge effects. The mean functional image was
registered to the magnitude image and unwarped using the shiftmap before coregistration to
the anatomy.
Reserve phase encoding based distortion correction (topup). FSL TOPUP (Smith et al. 2004)
was used to derive the off-resonance field from sets of images with reverse phase encoding
direction (Andersson et al. 2003). Processing and application of this field followed the same
steps as described for the B0 fieldmap above.
Nonlinear coregistration to anatomy for distortion correction (nonlinear). Nonlinear
coregistration of the mean functional and T1w images was carried out with ANTs applying
the symmetric diffeomorphic transformation model SyN and the fast cross-correlation
similarity metric (Avants et al. 2008). Extensive testing was performed to find optimal
preprocessing steps and ANTs parameter sets. After an initial exploratory phase a basic
procedure was fixed, which is depicted in Figures 1b and c and available online as a reusable
Nipype workflow and command line tool6. In short, the intensities of the brain extracted T1w
image were scaled and inverted to resemble the contrast of of the functional image. Careful
masking of EPI and T1w image preceded nonlinear coregistration, which was initiated with
the rigid transformation derived before. Starting from this essential pipeline, systematic
variation of four core aspects, namely masking, regularization, iterations and deformation
restriction, ensued (see Tab. 1 for details). The second testing phase was accompanied by
more formal evaluation as outlined in the Evaluation section below.
6

https://github.com/NeuroanatomyAndConnectivity/epi_t1_nonlinear

6

Evaluating nonlinear coregistration of BOLD EPI and T1 images

Simulation
An undistorted EPI image was simulated using FSL POSSUM (Drobnjak et al. 2010). Tissue
class images were derived from one arbitrarily selected subject of the LEMON cohort (cf.
Data acquisition) using FSL FAST (Zhang et al. 2001) to serve as the segmented anatomical
voxel model. Pulse sequence information was set to standard values (TR = 3 s, TE = 30 ms,
flip angle = 90°, voxel size = 4 × 4 × 3.6 mm, slice gap = 0.4 mm, FOV = 256 mm, 40 slices)
and thermal noise was added for a resultant signal-to-noise ratio of 10. The image was
blurred with a 2 mm Gaussian kernel. The subject’s real fieldmap was used to introduce
different levels of distortion using FSL FUGUE with echo spacing incrementing from 0.1 to
1 ms (Chambers et al. 2014; Bhushan et al. 2012) (Supplementary Fig. 3). Based on real data
values, the images were clipped at an intensity of twice their robust maximum. Similar to the
real data, the ten distorted images were registered to the subject’s T1w image and either no
(uncorrected), fieldmap or nonlinear distortion correction was applied.

Evaluation
Measures and images for evaluation were derived and plotted in an automated fashion using
Nipype, nibabel7 and nilearn8.
7
8

http://nipy.org/nibabel/
http://nilearn.github.io/

7

Evaluating nonlinear coregistration of BOLD EPI and T1 images

Visual inspection. Group averages of mean EPI images were created. To evaluate the fit to
anatomical structures, edge images were derived from the subject’s T1w image or the
MNI152 template, respectively, consisting of grey-white matter boundaries and the brain
mask outline. Intensity difference maps between the subjects’ mean functional images after
different forms of distortion correction were derived and combined into a group average map
for each contrast. EPI masks were created from each subject’s mean functional image using
FSL BET (Smith 2002) and used to derive minimal and average group masks and group mask
standard deviation. Deformation fields from the different correction methods were converted
to a common format and scaled for comparability. As fieldmap and topup shiftmaps are
restricted to one (the phase encoding) dimension, only this dimension could be considered for
evaluation
Quantitative measures. Similarity of EPI and T1w images was assessed in terms of
normalized mutual information (NMI) and correlation ratio (CR) within either a whole brain
mask or orbitofrontal regions as defined by the Harvard-Oxford probabilistic atlas (>25%)
(Supplementary Fig. 2). Voxelwise Spearman’s rank correlation was calculated between the
deformation fields and between the corrected mean functional images resulting from the
different correction methods. Likewise, for the simulated data, correlation between the
original distortion field and the nonlinear deformation field as well as correlation between the
undistorted image and the differentially corrected images was computed for each level of
distortion. The span between the robust minimum and maximum shift values was computed
for the deformation fields across subjects or levels of distortion respectively.

Results
Contrary to initial expectations, single parameter variations exhibited a complex patterning of
negative and positive consequences throughout optimization of nonlinear coregistration.
While an exhaustive account of the tested procedures is beyond the scope of this paper, the
following section describes a comparative evaluation of a subselection of nonlinear
coregistration pipelines along with the established correction methods. The selection was
made to provide a comprehensive picture of the impact of core parameters (see Tab. 1). The
results of all possible combinations of parameters can be found in the Supplementary
Material.

8

Evaluating nonlinear coregistration of BOLD EPI and T1 images

Overview nonlinear coregistration
Five sets of parameters are listed in Table 2, along with a broad outline of their outcomes.
Improvements and deteriorations are presented in comparison to the uncorrected case. A
more detailed discussion of the different aspects of evaluation in relation to fieldmap and
topup correction is provided in the subsequent sections. V1 represents the set of core
parameters that is closest to standard values for SyN transformation in ANTs. This setup
yields promising results in terms of the derived group mask and the deformation fields for
simulated data. Unfortunately, the remaining measures show worse outcomes for this version
than for no correction; large shift and CR values indicate overfitting. To counteract this
effect, deformations are limited more strictly to phase encoding direction in v2. While the
restriction causes the outcomes to be less extreme, the general evaluation pattern remains. For
a yet more conservative transformation, iterations are drastically reduced in v3. Evaluation of
this version arguably yields the best overall picture, although the deformation fields exhibit
reduced continuity. Additional strict limitation of deformation direction gives virtually the
same results (cf. v6 in Supplementary Material). In v4 the deformation is further confined to

9

Evaluating nonlinear coregistration of BOLD EPI and T1 images

regions that generally show high fieldmap values (Gholipour et al. 2008b). This might carry
the constraints too far, as the advantages over the uncorrected case further diminish. The
same picture occurs for additional strict limitation of the deformation direction (v7 in
Supplementary Material), while with increased iterations the restriction to the mask fails
altogether (v8 and v9 in Supplementary Material) . In v5 B-spline regularization is employed
to derive smoother deformation fields even with few iterations. Although the fields indeed
present more continuous, their spatial pattern is absolutely unreasonable for real data,
entailing consistently worse results in the evaluation. B-spline regularization does not yield
satisfactory results in combination with any other parameter sets either (v10 - v16 in
Supplementary Material).

Deformation fields
Deformation fields are evaluated using the subject’s fieldmap and topup derived shiftmap or
the ground truth distortion field as a reference. Overall, much closer resemblance to the
reference field is achieved for the simulated than for the real data (Fig. 2a vs b). Because
fields and correlations are highly similar between fieldmap and topup correction, Figure 2
only shows the results for the fieldmap based method for clarity. Outcomes for topup derived
fields can be found in Supplementary Figure 5 and 7. Nonlinear coregistration with v1
parameter settings achieves a decent convergence with the reference field in the simulation,
as showcased for an echo spacing of 0.7 ms in Figure 2a. Considering the full range of
distortion levels, correlation values start low but monotonically increase up to almost 0.65 for
an echo spacing of 1 ms (Fig. 2c). In stark contrast, the real data deformation fields differ
drastically from the reference fields, as exemplified on a single subject in Figure 2b. The
shifts partly even point in the opposite direction of the fieldmap which is reflected by
negative correlation values (Fig. 2d). The span between maximum positive and negative
shifts is higher than in the reference field for real data and simulated data with moderate
distortions (Fig. 2d,e). Deformation fields generated with higher directional restriction in v2
appear very similar to v1 visually, but correlation values indicate worse correspondence to
the reference field for the simulated data. The range of shift values is even larger than for v1
in both datasets. In v3 the reduction of iterations leads to reduced field continuity and shift
values. However, the reference field correlation and spatial pattern are clearly improved for

10

Evaluating nonlinear coregistration of BOLD EPI and T1 images

real data and similar to v2 for simulated data. Fieldmap masking in v4 generates very low
shift magnitudes even within the mask and low correlation to the reference fields. B-spline
regularization in v5 positively impacts on the smoothness of the fields and increases shift
magnitude. This however comes at the cost of declined spatial resemblance to the reference
field.

Group masks
The minimal group EPI masks delineate which areas of the brain are covered by signal in the
EPI image of each subject in the sample. The group mask after fieldmap correction illustrates
an increased coverage across subjects of prefrontal and anterior temporal areas as well as
posterior portions of the occipital lobe and the cerebellum (Fig. 3). However, more posterior
regions of orbitofrontal and temporal cortex, as well as parts of hippocampus, amygdala and
the pons are covered to a lesser extent by the group mask after fieldmap compared to no
correction. In frontal areas, the mask seems to partially extend beyond the cortex. The group
mask after topup correction shows a similar pattern, although differences to no correction are
slightly less extreme. After nonlinear coregistration according to v1, the mask shows similar
gains in frontal, temporal and cerebellar regions, but there is also an increased coverage in
OFC and no decrease in subcortical regions. Strict limitation to phase encoding direction in
v2 entails a mask shape similar to v1, although no increases occur in temporal and less in
orbitofrontal regions. The same is true for restricted iterations in v3 and additional fieldmap
masking in v4, although gains are generally even smaller. Finally, v5 with B-spline
regularization yields almost no increase of group mask extents. The spatial variability of EPI
masks across subjects as judged from mask group average and standard deviation reflect the
patterns described for the minimal group mask above (not shown).

11

Evaluating nonlinear coregistration of BOLD EPI and T1 images

12

Evaluating nonlinear coregistration of BOLD EPI and T1 images

Similarity to anatomy
Visual inspection of the group average EPI image in relation to anatomical reference reveals
two main aspects of fit, namely alignment of grey and white matter (gm/wm) boundaries and

13

Evaluating nonlinear coregistration of BOLD EPI and T1 images

fit to the outer brain contour. Figure 4a illustrates that both fieldmap and topup correction
greatly improve gm/wm fit, exemplified on the genu of the corpus callosum which suffers
substantial misregistration in the uncorrected image. While both corrections lead to a better
fulfillment of the brain outline in prefrontal and partly in temporal regions, the discrepancy
between EPI and T1w image in orbitofrontal areas increases. In line with these observations,
group level EPI to T1w similarity as assessed by normalized mutual information (NMI)
increases for the whole brain (Fig 4b, first row) but decreases when calculated within an OFC
mask (Fig 4c, first row). Excessive deformation through v1 nonlinear coregistration matches
the outer brain borders at the cost of massively corrupting gm/wm boundary fit. Moreover, a
blurry group average indicates inconsistent results across subjects. These observations are in
line with clearly reduced and widespread NMI values. Very high CR values imply overfitting
based on the closely related cross correlation metric that was used for nonlinear registration.
The group average of v2 is much clearer and shows better alignment of gm/wm boundaries,
as the EPI images is not stretched in ventral direction. At the same time, this leads to worse
outline fit in temporal regions. Whole brain NMI shows even lower values for v2 than for v1,
while the CR values are less extreme. V3 with fewer iterations improves both gm/wm and
outline fit compared to no correction, the former to a lesser and the latter to a greater extent
than fieldmap and topup correction. This is also reflected in the NMI values. CR values are
similar to v2. Restrictive masking in v4 results in slightly less improvement than achieved
with v3. B-spline regularization in v5 yields worse outline fits and whole brain NMI values.

Direct comparison of corrected images
Global voxelwise correlation of each subject’s EPI mean image across correction methods
(including no correction) yields overall high values (Fig 5a). However, based on intensity
difference maps, local distinctive features can be identified (Fig 5c) that support spatial
patterns observed for the group masks and anatomical fit. Because outcomes from fieldmap
and topup correction were again highly similar, only the results for fieldmap correction are
shown here (for topup results see Supplementary Fig. 11 and 13). Subtraction of the
uncorrected from the fieldmap corrected image illustrates increased signal intensity in
temporal and prefrontal areas and small posterior portions of the cerebellar and occipital
cortex after correction (Fig. 5c). In posterior OFC and around the genu of the corpus

14

Evaluating nonlinear coregistration of BOLD EPI and T1 images

callosum the intensity is decreased. Images corrected following v1 nonlinear coregistration
show by far the lowest correlation to fieldmap corrected images (Fig. 5a). From the
difference maps it becomes apparent that this correction involves drastic and widespread
intensity changes. In particular the corpus callosum and the straight sinus obviously
underwent major displacement. At the same time, the intensity decrease in OFC observed for
fieldmap correction is absent. These findings are also reflected in the direct contrast of the
fieldmap and nonlinearly corrected image (Fig 5c, second column). Deformation restriction in
v2 alleviates the extreme intensity changes, suiting increased correlation values. The

15

Evaluating nonlinear coregistration of BOLD EPI and T1 images

divergence in central areas remains, although it is more focused on straight sinus and the
splenium of the corpus callosum. A major difference to v1 and fieldmap correction is the lack
of intensity increase in temporal regions. While the latter issue also holds for v3, the
reduction in iterations succeeds to limit differences mostly to pre- and orbitofrontal areas (yet
without signal decrease in OFC). Only little deviations remain around the straight sinus,
which are diminished by fieldmap masking in v4. Finally, with B-spline regularization in v5,
nonlinear correction fails to produce intensity changes in areas affected by distortion and
instead leads to signal displacement around the straight sinus. Intensity values of one
subject’s fieldmap and nonlinear (v3) corrected images are plotted against each other in
Figure 5b.

Relation to ground truth
The simulated undistorted image is used as a ground truth for the arte

16

Evaluating nonlinear coregistration of BOLD EPI and T1 images

ificially distorted and subsequently corrected images. It is worth noting, that in this context,
fieldmap correction represents unwarping with the exact same field that was used to distort
the image in the first place. This procedure does not lead to a stainless recovery of the
undistorted image, because standard fieldmap correction does not account for the intensity
accumulations associated with geometric distortions (see Fig. 6b exemplifying visual
inspection for one level of distortion). Likewise, fieldmap correction does restore ground
truth correlation, especially for strong distortions, but not to the full extent (Fig. 6a).
Nonlinear coregistration in most cases entails a decline in correlation values, especially for
small to moderate distortions. Correction according to v1 leads to decreased correlation
values for all levels of distortion. Although the visual impression of the correction is
reasonable on the first glance, a closer look reveals that the image is excessively deformed in
the ventral direction. Moreover, the signal in orbitofrontal regions appears to be stretched in
posterior rather than anterior direction as would be appropriate judging from the distortion

17

Evaluating nonlinear coregistration of BOLD EPI and T1 images

field (see also Fig 2a, first vs second row). Correlation values for v2 closely resemble those
for v1, while visually the deformations seem to be less extreme, especially in OFC. Restricted
iterations in v3 still improve the visual appearance of the distorted image but to a lesser
extent than fieldmap correction. Quantitatively, correlation values are slightly increased
through the v3 correction for larger distortions (> 0.6 ms). Fieldmap masking in v4 gives a
similar picture. B-spline regularization (v5) seems to entail favourable results in terms of the
shape of the corpus callosum but not for frontal regions. Correlation to the ground truth is
relatively low.

Discussion
The two main objectives underlying the present study were straightforward implementation
and comprehensive large-scale evaluation of nonlinear coregistration for the correction of
distortion artefacts. While these overall aims were met, the obtained results call into question
the applicability of the investigated approach. The correction of distortion artefacts through
nonlinear coregistration was not successful in general. However, considerable variation in the
outcomes was observed across datasets and the employed measures partly diverged. The
initial evaluation of similar methods usually relies on few images or artifical data and fails to
capture the perfomance across larger and diverse datasets. The results obtained here highlight
the importance of secondary exhaustive assessments of new approaches in terms of
robustness and required conditions before the adoption to common analysis procedures can
be considered.

User-friendly implementation with commonplace tools
While former studies on nonlinear coregistration focused on the development of suitable
algorithms, the goal here was the translation into a practical preprocessing step. This was
realized by integrating the popular normalization tool ANTs (Avants et al. 2011) and
commands from other common neuroimaging software into a single easy-to-use pipeline with
Nipype (Gorgolewski et al. 2011) (Fig. 1). The applied transformation model SyN (Avants et
al. 2008) has been shown to outperform a number of available algorithms (Klein et al. 2009;
Murphy et al. 2011) and explicitly enables large deformations like those required in the
current use case. Importantly, this framework allows flexible parameter variation including

18

Evaluating nonlinear coregistration of BOLD EPI and T1 images

restriction of the deformation direction and B-Spline regularization (Tustison & Avants
2013). The pipeline only requires the EPI and surface extracted T1w image as inputs,
whereas existing approaches often rely on additional scans derived with spin echo EPI
(Studholme et al. 2000), high resolution gradient echo EPI (Gholipour et al. 2008a) or nonEPI (Villain et al. 2010) sequences. Computing the nonlinear transformation of a mean EPI
image using the proposed pipeline only takes a few minutes, whereas others report
computation times of about one hour (e.g. Gholipour et al. 2008a) .

Comprehensive evaluation employing multiple measures
The evaluation of accurate coregistration is not a trivial problem (Crum et al. 2004),
especially in the case of EPI and T1w image pairs where typical procedures such as manual
segmentation (Klein et al. 2009) are not feasible. Common practice is a combination of visual
inspection and quantitative similarity metrics like mutual information (Hutton et al. 2002;
Cusack et al. 2003). However, the former remains subjective and difficult for large samples9
and the latter does not provide any anatomical meaning (Crum et al. 2004). In previous
studies of nonlinear BOLD EPI and T1w coregistration, evaluation was usually limited to
these two measures (Kybic et al. 2000; Gholipour et al. 2008a), although Studholme and
colleagues additionally assessed the distance between manually placed landmarks
(Studholme et al. 2000). The present study employed a greater variety of outcome measures
to capture different aspects of registration quality. For instance, voxelwise correlation
(Chambers et al. 2014) (Fig. 5a,b and 6a,b) and direct intensity differences (Fig. 5c) provided
additional information about the corrected images. Careful examination of the deformation
fields (Fig. 2) turned out to be a valuable tool to assess the quality and remaining issues of the
transformation. The evaluation of minimal group masks (Fig. 3) addresses the pragmatic
issue of compromised group level overlap due to different artefacts across individuals
(Cusack et al. 2003). However, in the present context mask extents were not a reliable proxy
for overall performance (cf. Tab. 2, results for v1 and v2). The comprehensive assessment
came at the cost of a higher complexity of results, challenging overarching conclusions.
Coincidentally, converging evidence across measures regarding spatial aspects of group
masks, anatomical fit and intensity difference maps could strengthen ensuing conclusions and
9

still “careful visual inspection remains the first and most important validation check available for previously
unseen data” (Crum et al. 2004)

19

Evaluating nonlinear coregistration of BOLD EPI and T1 images

support validity of the single measures. Even divergence should not be considered a
drawback as the additional information can foster a deeper understanding of the method and
the results. For example, the two metrics used to measure EPI and T1w similarity yielded
disturbingly divergent results, with CR diagnosing much higher similarity after nonlinear
correction than NMI (Fig. 3b,c). This incoherence however, can be attributed to CR being
closely related to the metric used for optimization during the transformation. It is worth
noting, that all previous studies discussed above employ the same metric for optimization and
correction, potentially limiting the informational content of respective measures.

Comparative approach in a large sample
Apart from a more extensive set of outcome measures the present study stands out from prior
ones in terms of the employed dataset. In general, to improve feature control and establish a
ground truth comparison, earlier studies relied on simulated (Kybic et al. 2000; Gholipour et
al. 2008a) or phantom data (Studholme et al. 2000). Because such images do not reflect all
characteristics of real data and the obtained results remain an approximation, evaluation is
usually complemented with real data. Yet real datasets are typically confined to a few image
pairs (Studholme et al. 2000; Gholipour et al. 2008a). While Kybic and colleagues claim their
method was tested on “several hundreds of images”, documented results shrink to the visual
presentation of a single image with rather moderate distortions (Kybic et al. 2000). In
contrast, the results presented here are based on a total of 73 real images acquired according
to latest standards. Initial testing was performed on another set of over 300 images (Enhanced
Nathan Kline Institute - Rockland Sample) (Nooner et al. 2012) which did not undergo full
evaluation. Based on the large sample size, outcome measures could be obtained on the group
level to assess the method’s robustness and potential for widespread application. In fact,
visual inspection of single subjects’ corrected images partly appeared more reasonable than
the obtained group level results would suggest. This indicates a lack of robustness across
subjects and it is possible, that similar problems would be encountered if previous approaches
were tested on larger samples. The dataset also comprised additional scans for fieldmap and
reverse phase encoding based distortion correction. The proposed procedure could thus be
evaluated in direct comparison to tried and tested approaches, which is of particular interest
for guiding decisions in “real life” application. Again, this information is not contained in

20

Evaluating nonlinear coregistration of BOLD EPI and T1 images

most prior studies, although Kybic and colleagues compare their procedure to manual
correction (Kybic et al. 2000). To exploit the aforementioned advantages of synthetic data, a
simulation was performed in addition to the real data. Different from most prior approaches, a
real fieldmap was used to introduce realistic distortions as proposed by Chambers and
colleagues (Chambers et al. 2014). The evaluation outcomes differed considerably between
simulated and real data (Tab. 2), most obviously illustrated for the deformation fields (Fig. 2a
vs b). Potential reasons are manifold and include difference in resolution and smoothness as
well as extreme intensity accumulations in the simulated data (see Supplementary Fig. 3).
The latter implies that the nonlinear procedure could benefit from additional preprocessing to
overcome intensity nonuniformity (Chambers et al. 2014). In any case, these observations
underline the importance of thorough evaluation also based on real data.

Nonlinear coregistration: issues and insights
Nonlinear coregistration of BOLD EPI and T1w images within the proposed framework
turned out much more challenging than expected. First, a suitable preprocessing procedure
had to be set up to render the images suitable for direct coregistration (Fig. 1b). Because of
the multitude of (interacting) parameters in ANTs, extensive testing was required to find
reasonable settings. Throughout the testing process there emerged a general trade off between
the need for large deformations in affected areas on the one hand and unreasonable results
produced by unconstrained transformation on the other (cf. Tab. 2). Different approaches
were pursued to address this issue. Following Gholipour and colleagues, deformations were
restricted to phase encoding direction (Gholipour et al. 2008a). However, only when
convergence was prohibited through the reduction of iterations, the outcomes were notably
improved (v3). Because this approach conversely did not achieve sufficient correction, an
alternative idea was to allow convergence, but only within a mask comprising regions that
typically show high values in fieldmaps (Supplementary Fig. 1). Unfortunately, ANTs was
very sensitive regarding image masking; the expected spatial restriction could not be realized
for a high number of iterations (cf. v8 and v9 in Supplementary Material) and posed too high
constraints when combined with few iterations (v4). While explicit B-Spline regularization of
the deformation fields succeeded to enforce physically plausible smoothness, no satisfactory
correction could be obtained (v5 and v10 - v16 in Supplementary Material). This is surprising

21

Evaluating nonlinear coregistration of BOLD EPI and T1 images

in so far, as previous approaches successfully use spline based estimation (Kybic et al. 2000;
Studholme et al. 2000; Gholipour et al. 2008a). A possible explanation is that with 26 mm the
initial knot spacing was set too high and supported registration of far apart image features in
the absence of sufficient information in the EPI image (Studholme et al. 2000).
While nonlinear coregistration in general performed drastically worse than fieldmap and
topup correction, one distinctive feature stands out, that on the first glance could be deemed
an advantage. EPI signal coverage and similarity to the structural image decreased through
fieldmap and topup correction in the OFC, while they mostly increased with nonlinear
coregistration (Fig. 3 and 4). However, this observation can probably be explained by actual
signal loss in the OFC due to spin dephasing within single voxels (Ojemann et al. 1997;
Glover 1999). Distortions and dropout are related but distinct phenomena and the latter is
usually not addressed by retrospective correction methods discussed here (although see
Jenkinson 2004). It seems likely that fieldmap and topup corrected images accurately reflect
the signal loss, while nonlinear coregistration attempts to overcome this loss by artificially
stretching signal into the affected regions. This is in line with poor results for the case of
simulated signal loss reported by Gholipour and colleagues (Gholipour et al. 2008a). Given
the observed extension of EPI signal beyond the brain particularly after fieldmap correction
(Fig 3 second row), it is possible but not highly likely that a tendency for overcorrection
brings about more signal decrease in OFC than would be appropriate.

Limitations and future directions
The limitations of the proposed method are obvious and should discourage its premature use.
Importantly, the presented results pertain to the specific procedure and tools that used here
and do not necessarily hold for alternative implementations. Notwithstanding the current
issues, the basic idea of nonlinear coregistration for distortion correction bears potential and
should continue to be explored. An interesting approach has been suggested by Gholipour
and colleagues (Gholipour 2008c). They use a fieldmap template for an initial coarse round
of deformation which is subsequently refined through nonlinear coregistration. Thus the
critical gross displacements are dealt with by the fieldmap while nonlinear transformation
provides accurate individual alignment. However, this procedure depends on a reasonable
fieldmap template. Future work might establish to what extent such a template generalizes

22

Evaluating nonlinear coregistration of BOLD EPI and T1 images

across studies and can circumvent the need for additional scans. Along similar lines, Daga
and colleagues (Daga et al. 2013) proposed an elegant procedure combining phase
unwrapping with confidence estimation regarding the obtained B0 field to confine the
following nonlinear registration to low confidence areas. While the latter approach does not
obliviate fieldmap acquisition, the combination of methods holds additional potential to
overcome a considerable drawback of fieldmap (and topup) based procedures: due to their
static nature fieldmaps cannot account for artefacts arising from the interaction of distortion
and subject movement (Andersson et al. 2001; Jezzard 2012). Fieldmap correction followed
by individual nonlinear refinement of each volume in a time series could be a solution.
Another objective of future research should be to assess the impact of nonlinear
coregistration, and distortion correction in general, on subsequent function analyses. This has
been addressed to some extent in terms of task-based activations (Cusack et al. 2003; Villain
et al. 2010) and an attempt to assess changes in resting state functional connectivity was
made in the context of the current project (see Supplementary Fig. 15). However, both
approaches suffer from the absence of a ground truth comparison. As distortion artefacts
increase with field strength (Dietrich et al. 2008), adequate correction will gain importance
with the current rise of ultra high field fMRI (Jezzard 2012). Remarkable improvements in
contrast and resolution that can be achieved with EPI sequences at 7 Tesla might at the same
time call for and facilitate nonlinear coregistration.

Conclusion
Direct nonlinear BOLD EPI to T1w coregistration was implemented in a user-friendly
framework and thoroughly evaluated on a large dataset. Despite extensive attempts to
optimize the correction, no satisfactory results could be obtained. The trade off between large
deformations and suitable constraints as well as the lack of robustness across subjects and
data types emerged as the prevailing issues. While the former problem might be overcome
with more specifically tailored transformation algorithms or a combination with general
information from fieldmaps, the latter concern is potentially harder to address. In the face of
individual differences in distortions and varying image quality, robust automatization of
nonlinear BOLD EPI and T1w coregistration is difficult to achieve. On these grounds
extensive critical evaluation of respective approaches is of crucial importance.

23

Evaluating nonlinear coregistration of BOLD EPI and T1 images

Acknowledgments
I am grateful for excellent supervision by Daniel S. Margulies and Felix Blankenburg as well
as for outstanding methodological guidance by Chris Gorgolewski, Alfred Anwander, Jan
Schreiber, Pierre-Louis Bazin and Mark Jenkinson. Special thanks belong to the LEMON
crew for providing the data, Ali Gholipour for sharing the fieldmap template and to the Group
for Neuroanatomy and Connectivity at the MPI CBS Leipzig.

Supplementary material
The supplementary material can be found in an accompanying file and online under
http://goo.gl/JIqFpH

References
Andersson, J.L. et al., 2001. Modeling geometric deformations in EPI time series. NeuroImage, 13(5),
pp.903–919.
Andersson, J.L.R., Skare, S. & Ashburner, J., 2003. How to correct susceptibility distortions in spinecho echo-planar images: application to diffusion tensor imaging. NeuroImage, 20(2), pp.870–
888.
Avants, B.B. et al., 2011. A reproducible evaluation of ANTs similarity metric performance in brain
image registration. NeuroImage, 54(3), pp.2033–2044.
Avants, B.B. et al., 2008. Symmetric diffeomorphic image registration with cross-correlation:
evaluating automated labeling of elderly and neurodegenerative brain. Medical image analysis,
12(1), pp.26–41.
Bazin, P.-L. et al., 2014. A computational framework for ultra-high resolution cortical segmentation at
7Tesla. NeuroImage, 93 Pt 2, pp.201–209.
Bhushan, C. et al., 2012. Correcting Susceptibility-Induced Distortion in Diffusion-Weighted MRI
using Constrained Nonrigid Registration. In Signal Information Processing Association Annual
Summit and Conference (APSIPA ASC). pp. 1–9.
Brett, M., Johnsrude, I.S. & Owen, A.M., 2002. The problem of functional localization in the human
brain. Nature reviews. Neuroscience, 3(3), pp.243–249.
Carass, A. et al., 2011. Simple paradigm for extra-cerebral tissue removal: algorithm and analysis.
NeuroImage, 56(4), pp.1982–1992.
Chambers, M.C. et al., 2014. Registration-Based Distortion and Intensity Correction in fMRI.
Chen, N.K. & Wyrwicz, A.M., 1999. Correction for EPI distortions using multi-echo gradient-echo
imaging. Magnetic resonance in medicine: official journal of the Society of Magnetic Resonance
in Medicine / Society of Magnetic Resonance in Medicine, 41(6), pp.1206–1213.
24

Evaluating nonlinear coregistration of BOLD EPI and T1 images

Crum, W.R., Hartkens, T. & Hill, D.L.G., 2004. Non-rigid image registration: theory and practice.
The British journal of radiology, 77 Spec No 2, pp.S140–53.
Cusack, R., Brett, M. & Osswald, K., 2003. An evaluation of the use of magnetic field maps to
undistort echo-planar images. NeuroImage, 18(1), pp.127–142.
Daga, P. et al., 2013. Susceptibility artefact correction by combining B0 field maps and non-rigid
registration using graph cuts. In SPIE Medical Imaging. International Society for Optics and
Photonics, p. 86690B–86690B–6.
Dale, A.M., Fischl, B. & Sereno, M.I., 1999. Cortical surface-based analysis. I. Segmentation and
surface reconstruction. NeuroImage, 9(2), pp.179–194.
Dietrich, O., Reiser, M.F. & Schoenberg, S.O., 2008. Artifacts in 3-T MRI: physical background and
reduction strategies. European journal of radiology, 65(1), pp.29–35.
Drobnjak, I., Pell, G.S. & Jenkinson, M., 2010. Simulating the effects of time-varying magnetic fields
with a realistic simulated scanner. Magnetic resonance imaging, 28(7), pp.1014–1021.
Fischl, B., Sereno, M.I. & Dale, A.M., 1999. Cortical surface-based analysis. II: Inflation, flattening,
and a surface-based coordinate system. NeuroImage, 9(2), pp.195–207.
Gholipour, A. et al., 2008b. Average field map image template for Echo-Planar image analysis.
Conference proceedings: ... Annual International Conference of the IEEE Engineering in
Medicine and Biology Society. IEEE Engineering in Medicine and Biology Society. Conference,
2008, pp.94–97.
Gholipour, A. et al., 2007. Brain functional localization: a survey of image registration techniques.
IEEE transactions on medical imaging, 26(4), pp.427–451.
Gholipour, A. et al., 2008c. Cross-Validation of Deformable Registration With Field Maps in
Functional Magnetic Resonance Brain Imaging. IEEE journal of selected topics in signal
processing, 2(6), pp.854–869.
Gholipour, A. et al., 2008a. Validation of non-rigid registration between functional and anatomical
magnetic resonance brain images. IEEE transactions on biomedical engineering, 55(2 Pt 1),
pp.563–571.
Glover, G.H., 1999. 3D z-shim method for reduction of susceptibility effects in BOLD fMRI.
Magnetic resonance in medicine: official journal of the Society of Magnetic Resonance in
Medicine / Society of Magnetic Resonance in Medicine, 42(2), pp.290–299.
Gorgolewski, K. et al., 2011. Nipype: a flexible, lightweight and extensible neuroimaging data
processing framework in python. Frontiers in neuroinformatics, 5, p.13.
Greve, D.N. & Fischl, B., 2009. Accurate and robust brain image alignment using boundary-based
registration. NeuroImage, 48(1), pp.63–72.
Holland, D., Kuperman, J.M. & Dale, A.M., 2010. Efficient correction of inhomogeneous static
magnetic field-induced distortion in Echo Planar Imaging. NeuroImage, 50(1), pp.175–183.
Hutton, C. et al., 2002. Image distortion correction in fMRI: A quantitative evaluation. NeuroImage,
16(1), pp.217–240.
25

Evaluating nonlinear coregistration of BOLD EPI and T1 images

Jenkinson, M. et al., 2012. FSL. NeuroImage, 62(2), pp.782–790.
Jenkinson, M. et al., 2002. Improved optimization for the robust and accurate linear registration and
motion correction of brain images. NeuroImage, 17(2), pp.825–841.
Jenkinson, M., 2004. Improving the registration of B0-distorted EPI images using calculated cost
function weights.
Jenkinson, M. & Smith, S., 2001. A global optimisation method for robust affine registration of brain
images. Medical image analysis, 5(2), pp.143–156.
Jezzard, P., 2012. Correction of geometric distortion in fMRI data. NeuroImage, 62(2), pp.648–651.
Jezzard, P. & Balaban, R.S., 1995. Correction for geometric distortion in echo planar images from B0
field variations. Magnetic resonance in medicine: official journal of the Society of Magnetic
Resonance in Medicine / Society of Magnetic Resonance in Medicine, 34(1), pp.65–73.
Jezzard, P. & Clare, S., 1999. Sources of distortion in functional MRI data. Human brain mapping,
8(2-3), pp.80–85.
Klein, A. et al., 2009. Evaluation of 14 nonlinear deformation algorithms applied to human brain MRI
registration. NeuroImage, 46(3), pp.786–802.
Kybic, J. et al., 2000. Unwarping of unidirectionally distorted EPI images. IEEE transactions on
medical imaging, 19(2), pp.80–93.
Lucas, B.C. et al., 2010. The Java Image Science Toolkit (JIST) for rapid prototyping and publishing
of neuroimaging software. Neuroinformatics, 8(1), pp.5–17.
Mansfield, P., 1977. Multi-planar image formation using NMR spin echoes. Journal of Physics C:
Solid State Physics, 10(3), p.L55.
McAuliffe, M.J. et al., 2001. Medical Image Processing, Analysis and Visualization in clinical
research. In Computer-Based Medical Systems, 2001. CBMS 2001. Proceedings. 14th IEEE
Symposium on. pp. 381–386.
Murphy, K. et al., 2011. Evaluation of registration methods on thoracic CT: the EMPIRE10 challenge.
IEEE transactions on medical imaging, 30(11), pp.1901–1920.
Nooner, K.B. et al., 2012. The NKI-Rockland Sample: A Model for Accelerating the Pace of
Discovery Science in Psychiatry. Frontiers in neuroscience, 6, p.152.
Ogawa, S. et al., 1990. Brain magnetic resonance imaging with contrast dependent on blood
oxygenation. Proceedings of the National Academy of Sciences of the United States of America,
87(24), pp.9868–9872.
Ojemann, J.G. et al., 1997. Anatomic localization and quantitative analysis of gradient refocused
echo-planar fMRI susceptibility artifacts. NeuroImage, 6(3), pp.156–167.
Reber, P.J., Wong, E.C. & Buxton, R.B., 1998. Correction of off resonance ‐related distortion in echo ‐
planar imaging using EPI‐based field maps. Magnetic resonance insights.

26

Evaluating nonlinear coregistration of BOLD EPI and T1 images

Smith, S.M. et al., 2004. Advances in functional and structural MR image analysis and
implementation as FSL. NeuroImage, 23 Suppl 1, pp.S208–19.
Smith, S.M., 2002. Fast robust automated brain extraction. Human brain mapping, 17(3), pp.143–155.
Studholme, C., Constable, R.T. & Duncan, J.S., 2000. Accurate alignment of functional EPI data to
anatomical MRI using a physics-based distortion model. IEEE transactions on medical imaging,
19(11), pp.1115–1127.
Tao, R. et al., 2009. A variational image-based approach to the correction of susceptibility artifacts in
the alignment of diffusion weighted and structural MRI. Information processing in medical
imaging: proceedings of the ... conference, 21, pp.664–675.
Toga, A.W. & Thompson, P.M., 2001. The role of image registration in brain mapping. Image and
vision computing, 19(1-2), pp.3–24.
Tustison, N.J. & Avants, B.B., 2013. Explicit B-spline regularization in diffeomorphic image
registration. Frontiers in neuroinformatics, 7, p.39.
Villain, N. et al., 2010. A simple way to improve anatomical mapping of functional brain imaging.
Journal of neuroimaging: official journal of the American Society of Neuroimaging, 20(4),
pp.324–333.
Weisskoff, R.M. & Davis, T.L., 1992. Correcting gross distortion on echo planar images. 11th Ann.
Sci. Mtg. Soc. of Magn. Reson. in Med.
Wu, M. et al., 2008. Comparison of EPI distortion correction methods in diffusion tensor MRI using a
novel framework. Medical image computing and computer-assisted intervention: MICCAI ...
International Conference on Medical Image Computing and Computer-Assisted Intervention,
11(Pt 2), pp.321–329.
Zhang, Y., Brady, M. & Smith, S., 2001. Segmentation of brain MR images through a hidden Markov
random field model and the expectation-maximization algorithm. IEEE transactions on medical
imaging, 20(1), pp.45–57.

27

Evaluating nonlinear coregistration of BOLD EPI and T1 images

Erklärung
Hiermit erkläre ich, dass ich vorliegende Arbeit selbständig verfasst und keine anderen als die
angegebenen Quellen und Hilfsmittel benutzt habe.

………………………………………………………………………………………………......
Berlin, 20. August 2014

28

